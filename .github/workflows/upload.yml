name: Create Release

permissions:
  contents: write

on:
  workflow_run:
    workflows: ["Build Apps"]  # must exactly match the name of your build workflow
    types:
      - completed

jobs:
  create-release:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.ref == 'refs/heads/master' }}

    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: bye unpacked ðŸ‘‹
        run: find artifacts/ -type d -name '*-unpacked' -exec rm -rf {} +

      - name: bye unpacked gtk windows ðŸ‘‹
        run: find artifacts/ -type d -name 'build' -exec rm -rf {} +

      - name: Generate SHA256 Hashes
        run: |
          cd artifacts
          for file in *; do
            if [ -f "$file" ]; then
              sha256sum "$file" >> SHA256SUMS.txt
            fi
          done

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.run_number }}
          name: Release v${{ github.run_number }}
          draft: false
          prerelease: false
          files: |
            artifacts/*/*.tar.gz
            artifacts/*/*.deb
            artifacts/*/*.rpm
            artifacts/*/*.exe
            artifacts/*/*.AppImage
            artifacts/*/*.zip
            artifacts/*/*.msi

            artifacts/*.tar.gz
            artifacts/*.deb
            artifacts/*.rpm
            artifacts/*.exe
            artifacts/*.AppImage
            artifacts/*.zip
            artifacts/*.msi
            
            artifacts/googleballs-desktop
            artifacts/SHA256SUMS.txt
          body: |
            ## Release v${{ github.run_number }}
            
            ### Checksums
            ```
            $(cat artifacts/SHA256SUMS.txt)
            ```
